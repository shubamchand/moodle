YUI.add("moodle-atto_sketch-button",function(e,t){var n="atto_sketch",r="storeinrepo",i={ISPERCENT:/\d+%/},s=M.cfg.wwwroot+"/lib/editor/atto/plugins/sketch/sketch.html",o="sketchpad",u="submit",a={INPUTSUBMIT:"atto_sketch_submit",HGT:"height: calc(100% - 40px);",WDT:"width: 100%;"},f='<iframe src="{{isource}}" id="{{iframeID}}" style="{{CSS.HGT}}{{CSS.WDT}}" scrolling="auto" frameborder="0"></iframe><div style="text-align:center"><button class="mdl-align {{CSS.INPUTSUBMIT}}" id="{{submitid}}" style="{{selectalign}}">{{get_string "insert" component}}</button></div>',l='<img src="{{url}}" alt="{{alt}}" {{#if width}}width="{{width}}" {{/if}}{{#if height}}height="{{height}}" {{/if}}{{#if presentation}}role="presentation" {{/if}}{{#if customstyle}}style="{{customstyle}}" {{/if}}{{#if classlist}}class="{{classlist}}" {{/if}}{{#if id}}id="{{id}}" {{/if}}/>',c=null;e.namespace("M.atto_sketch").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{initializer:function(){if(!this.get("host").canShowFilepicker("media")&&this.get(r)>0)return;var e="iconone";this.addButton({icon:"ed/"+e,iconComponent:"atto_sketch",buttonName:e,callback:this._displayDialogue,callbackArgs:e,tags:"img",tagMatchRequiresAll:!1})},_convertImage:function(e){var t;e.split(",")[0].indexOf("base64")>=0?t=atob(e.split(",")[1]):t=decodeURI(e.split(",")[1]);var n=e.split(",")[0].split(":")[1].split(";")[0],r=new Uint8Array(t.length);for(var i=0;i<t.length;i++)r[i]=t.charCodeAt(i);return new Blob([r],{type:n})},_doInsert:function(t){var r=this,i=this.get("host"),s=e.Handlebars.compile(l);i.saveSelection(),t=t._event;var o=r._convertImage(c.getImage().toDataURL()),u=o&&o.size&&o.type=="image/png";if(u){var a=i.get("filepickeroptions").image,f=a.savepath===undefined?"/":a.savepath,h=new FormData,p=0,d="",v=new XMLHttpRequest,m="",g=Object.keys(a.repositories);t.preventDefault(),t.stopPropagation(),h.append("repo_upload_file",o),h.append("itemid",a.itemid);for(var y=0;y<g.length;y++)if(a.repositories[g[y]].type==="upload"){h.append("repo_id",a.repositories[g[y]].id);break}return h.append("env",a.env),h.append("sesskey",M.cfg.sesskey),h.append("client_id",a.client_id),h.append("savepath",f),h.append("ctx_id",a.context.id),p=(new Date).getTime(),d="moodleimage_"+Math.round(Math.random()*1e5)+"-"+p,r.getDialogue({focusAfterHide:null}).hide(),i.focus(),i.restoreSelection(),m=s({url:M.util.image_url("i/loading_small","moodle"),alt:M.util.get_string("uploading",n),id:d}),i.insertContentAtFocusPoint(m),r.markUpdated(),v.onreadystatechange=function(){var t=r.editor.one("#"+d),n,i,o,u;if(v.readyState===4)if(v.status===200){n=JSON.parse(v.responseText);if(n){if(n.error)return t&&t.remove(!0),new M.core.ajaxException(n);i=n,n.event&&n.event==="fileexists"&&(i=n.newfile),o=s({url:i.url,presentation:!0}),u=e.Node.create(o),t?t.replace(u):r.editor.appendChild(u),r.markUpdated()}}else e.use("moodle-core-notification-alert",function(){new M.core.alert({message:M.util.get_string("servererror","moodle")})}),t&&t.remove(!0);return!0},v.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload",!0),v.send(h),!0}return!0},_getSelectedImageProperties:function(){var e={src:null,alt:null,width:null,height:null},t=this.get("host").getSelectedNodes(),n,r;return t&&(t=t.filter("img")),t&&t.size()?(this._selectedImage=t.item(0),n=this._selectedImage.getAttribute("width"),n.match(i.ISPERCENT)||(n=parseInt(n,10)),r=this._selectedImage.getAttribute("height"),r.match(i.ISPERCENT)||(r=parseInt(r,10)),n!==0&&(e.width=n),r!==0&&(e.height=r),e.src=this._selectedImage.getAttribute("src"),e.alt=this._selectedImage.getAttribute("alt")||"",e):(this._selectedImage=null,!1)},_displayDialogue:function(t,r){var i="100%",u="100vh",a,f;f=this.getDialogue({headerContent:M.util.get_string("sketchtitle",n),width:i,height:u,focusAfterHide:r}),t.preventDefault(),f.after("visibleChange",function(){var e=f.getAttrs();e.visible===!1&&setTimeout(function(){f.reset()},5)}),f.width!==i+"px"&&f.set("width",i+"px"),f.height!==u+"px"&&f.set("height",u+"px"),a=this._getFormContent(r),f.set("bodyContent",a),document.getElementById(o).src=s,f.centerDialogue(),f.show(),this.markUpdated();var l=!1;this.get("host").getSelection()!==!1&&(l=this._getSelectedImageProperties()),document.getElementById(o).addEventListener("load",function(){var t=document.getElementById(o).contentDocument.getElementsByClassName("literally")[0],n=document.getElementById(o).contentWindow;c=n.LC.init(t,{imageURLPrefix:"assets/img",tools:n.LC.defaultTools.concat([n.regularShapes])});if(l){var r=new Image;r.src=l.src;var i=n.LC.createShape("Image",{x:10,y:10,image:r});c.saveShape(i)}if(navigator.userAgent.indexOf("MSIE")!==-1||navigator.appVersion.indexOf("Trident/")>0){var s=document.documentElement.clientHeight;e.one(".moodle-dialogue-focused")&&e.one(".moodle-dialogue-focused").setStyle("height",s+"px"),e.one(".moodle-dialogue-focused .moodle-dialogue-bd")&&e.one(".moodle-dialogue-focused .moodle-dialogue-bd").setStyle("height",s-50+"px")}e.one(".moodle-dialogue-focused")&&(e.one(".moodle-dialogue-focused").setStyle("position","fixed"),e.one(".moodle-dialogue-focused").setStyle("z-index","9999"),e.one(".moodle-dialogue-focused").setStyle("top","0"),e.one(".moodle-dialogue-focused").setStyle("left","0")),e.one(".moodle-dialogue-focused .moodle-dialogue-bd")&&(e.one(".moodle-dialogue-focused .moodle-dialogue-bd").setStyle("height","calc(100% - 50px)"),e.one(".moodle-dialogue-focused .moodle-dialogue-bd").setStyle("padding","0")),e.one(".moodle-dialogue-focused").ancestor(".moodle-dialogue-base")&&e.one(".moodle-dialogue-focused").ancestor(".moodle-dialogue-base").setStyle("bottom","0"),e.one(".moodle-dialogue-focused").ancestor(".moodle-dialogue-fullscreen")&&e.one(".moodle-dialogue-focused").ancestor(".moodle-dialogue-fullscreen").setStyle("bottom","0")})},_getFormContent:function(t){var i=e.Handlebars.compile(f),l=e.Node.create(i({elementid:this.get("host").get("elementid"),CSS:a,component:n,clickedicon
:t,isource:s,iframeID:o,submitid:u}));return this._form=l,this.get(r)>0?this._form.one("."+a.INPUTSUBMIT).on("click",this._doInsert,this):this._form.one("."+a.INPUTSUBMIT).on("click",this._doInsertBase64,this),l},_doInsertBase64:function(e){e.preventDefault();var t=this,n=c.getImage().toDataURL(),r='<img src="'+n+'" />';t.getDialogue({focusAfterHide:null}).hide(),t.editor.focus(),t.get("host").insertContentAtFocusPoint(r),t.markUpdated()}},{ATTRS:{storeinrepo:{value:0}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
