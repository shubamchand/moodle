define(["jquery","core/str"],function(a,b){var c={};return c.plugin="qtype_essayautograde",c.str={},c.itemtype="",c.itemmatch="",c.editortype="",c.editormaxtries=50,c.editorinterval=100,c.responsesample="",c.responseoriginal="",c.init=function(a,b,d,e){var f="";switch(b){case"chars":f=".";break;case"words":f="\\w+";break;case"sentences":f="[^\\.?!]+[\\.?!]";break;case"paragraphs":f="[^\\r\\n]+[\\r\\n]*"}c.itemtype=b,c.itemmatch=new RegExp(f,"g"),c.editortype=d,a?c.setup_response_heights():(c.setup_itemcounts(),c.setup_responsesample(e))},c.setup_response_heights=function(){a("textarea.qtype_essay_response").each(function(){a(this).height(1),a(this).height(this.scrollHeight)})},c.setup_itemcounts=function(){a(".qtype_essay_response").each(function(){var b=c.get_itemcount_id(this),d=a.Deferred();c.check_editor(this,d),a.when(d).done(a.proxy(function(){c.create_itemcount(this,b),c.setup_itemcount(this,b)},this,b))})},c.check_editor=function(b,d){var e="";switch(c.editortype){case"atto":e="[contenteditable=true]";break;case"tinymce":e="iframe"}if(""==e)d.resolve();else var f=setInterval(function(){a(b).find(e).length&&(clearInterval(f),d.resolve())},c.editorinterval)},c.create_itemcount=function(a,b){if(null===document.getElementById(b)){var c=document.createElement("P");c.setAttribute("id",b),c.setAttribute("class","itemcount"),a.parentNode.insertBefore(c,a.nextSibling)}},c.setup_itemcount=function(b,d){var e=c.get_editable_element(b);e&&(a(e).keyup(function(){c.show_itemcount(this,d)}),c.show_itemcount(e,d))},c.get_editable_element=function(b){if("TEXTAREA"==a(b).prop("tagName"))return b;var c=a(b).find("[contenteditable=true]");if(c.length)return c.get(0);var d=b.getElementsByTagName("IFRAME");if(d.length){d=d[0];var e=d.contentWindow||d.contentDocument;if(e.document&&(e=e.document),e.body&&e.body.isContentEditable)return e.body}var c=a(b).find("textarea");return c.length?c.get(0):null},c.get_textarea=function(b){return"TEXTAREA"==a(b).prop("tagName")?b:a(b).find("textarea").get(0)},c.get_textarea_name=function(b){var d=c.get_textarea(b);return a(d).attr("name")},c.get_itemcount_id=function(a){var b=c.get_textarea_name(a);return"id_"+b+"_itemcount"},c.escape=function(a){var b=new RegExp("(:|\\.|\\[|\\]|,|=|@)","g");return"#"+a.replace(b,"\\$1")},c.show_itemcount=function(d,e){if("TEXTAREA"==a(d).prop("tagName"))var f=a(d).val().match(c.itemmatch);else var f=a(d).text().match(c.itemmatch);f=f?f.length:0,b.get_strings([{key:c.itemtype,component:c.plugin}]).done(function(b){a(c.escape(e)).text(b[0]+": "+f)})},c.setup_responsesample=function(d){""!=d&&(c.responsesample=d,b.get_strings([{key:"hidesample",component:c.plugin},{key:"showsample",component:c.plugin}]).done(function(b){c.str.hidesample=b[0],c.str.showsample=b[1];var d=a(".qtext").find("p:not(:empty), div:not(:empty)");d=d.length?d.last():a(".qtext"),d.append(a("<span></span>").click(function(){var b="",d="",e=!1;a(this).hasClass("showsample")?(a(this).removeClass("showsample").addClass("hidesample").text(c.str.hidesample),b=c.responsesample,e=!0):(a(this).removeClass("hidesample").addClass("showsample").text(c.str.showsample),b=c.responseoriginal);var f=null,g=a(this).closest(".qtext");if("audio"==c.editortype||"video"==c.editortype)f=g.find(".audiovideo_response_prompt");else{var h=g.next(".ablock").find(".answer .qtype_essay_response");h.is("[name$='_answer']")?f=h:(f=h.find("[contenteditable=true]"),0==f.length&&(f=h.find("iframe").contents().find("[contenteditable=true]"),0==f.length&&(f=h.find("[name$='_answer']"))))}return null!==f&&0!=f.length&&("TEXTAREA"==f.prop("tagName")?(d=f.val(),f.val(b).keyup()):(d=f.text(),f.text(b).keyup()),e&&(c.responseoriginal=d),!0)}).trigger("click"))}))},c});